#include <rtthread.h>
#include <rtdevice.h>
#include "utest.h"
#include "hm_hci_transport_h4.h"
#include "hm_chipset.h"


hm_chipset_t *chipset_instance;

static rt_err_t utest_tc_init(void)
{
    hci_trans_h4_open();

    chipset_instance = hm_chipset_get_instance();

    return RT_EOK;
}

static rt_err_t utest_tc_cleanup(void)
{

    hci_trans_h4_close();

    chipset_instance = NULL;

    return RT_EOK;
}

static uint8_t reset_cmd[] = {0x03, 0x0C, 0x00};
static uint8_t reset_cmd_event[] = {0x0E, 0x04, 0x01, 0x03, 0x0C, 0x00};

/* Used for CSR8311 test */
static uint8_t chipset_send2[] = {0x01,0x10,0x00};
static uint8_t chipset_recv2[] = {0x0E,0x0C,0x01,0x01,0x10,0x00,0x06,0x31,0x20,0x06,0x0A,0x00,0x31,0x20};
static uint8_t chipset_send3[] = {0x14,0x0C,0x00};
static uint8_t chipset_recv3[] = {0x0E,0xFC,0x01,0x14,0x0C,0x00,0x43,0x53,0x52,0x20,0x2D,0x20,0x62,0x63,0x37,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                            0x00,0x00,0x00,0x00};

void test_chip_hci_cmd_send_evt_recv(void)
{
    int err;
    uint8_t recv[256];

    err = chip_hci_cmd_send(reset_cmd, ARRAY_SIZE(reset_cmd));
    uassert_int_equal(err, HM_SUCCESS);
    
    err = chip_hci_event_read(recv, ARRAY_SIZE(recv));
    uassert_int_equal(err, HM_SUCCESS);
    uassert_buf_equal(recv, reset_cmd_event, ARRAY_SIZE(reset_cmd_event));


    err = chip_hci_cmd_send(chipset_send2, ARRAY_SIZE(chipset_send2));
    uassert_int_equal(err, HM_SUCCESS);
    
    err = chip_hci_event_read(recv, ARRAY_SIZE(recv));
    uassert_int_equal(err, HM_SUCCESS);
    uassert_buf_equal(recv, chipset_recv2, ARRAY_SIZE(chipset_recv2));


    err = chip_hci_cmd_send(chipset_send3, ARRAY_SIZE(chipset_send3));
    uassert_int_equal(err, HM_SUCCESS);
    
    err = chip_hci_event_read(recv, ARRAY_SIZE(recv));
    uassert_int_equal(err, HM_SUCCESS);
    uassert_buf_equal(recv, chipset_recv3, ARRAY_SIZE(chipset_recv3));
}

void test_csr8311_init(void)
{
    int err;
    uint8_t *p = NULL;

    do {
        chip_hci_cmd_send(reset_cmd, ARRAY_SIZE(reset_cmd));
        rt_kprintf("CMD => 03 0C 00\n");
        err = hci_trans_h4_recv_event(&p, 100);
        if (err) {
            rt_kprintf("Resend reset\n");
        }
    } while (err != HM_SUCCESS && p == NULL);

    hci_trans_h4_recv_free(p);
    p = NULL;

    rt_kprintf("SCR8311 start init\n");

    err = chipset_instance->init();
    uassert_int_equal(err, HM_SUCCESS);


    do {
        chip_hci_cmd_send(reset_cmd, ARRAY_SIZE(reset_cmd));
        rt_kprintf("CMD => 03 0C 00\n");
        err = hci_trans_h4_recv_event(&p, 100);
        if (err) {
            rt_kprintf("Resend reset\n");
        }
    } while (err != HM_SUCCESS && p == NULL);

    hci_trans_h4_recv_free(p);
    p = NULL;

}

static void testcase_chipset(void)
{
//    UTEST_UNIT_RUN(test_chip_hci_cmd_send_evt_recv);
    UTEST_UNIT_RUN(test_csr8311_init);
}
UTEST_TC_EXPORT(testcase_chipset, "hm.chipset", utest_tc_init, utest_tc_cleanup, 1000);

